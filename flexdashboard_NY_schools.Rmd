---
title: "New York State Public Schools"
output: 
 flexdashboard::flex_dashboard:
   orientation: columns
   source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(reshape2)
library(shiny)

```

```{r global, include=FALSE}
#Prepare the dataset
# Read and examine fields of dataset
df_NY_schools <- read.csv(file = "GRAD_RATE_AND_OUTCOMES_2018.csv")

df_NY_schools[, c(20:36)] <- sapply(df_NY_schools[, c(20:36)], as.character)

# Change the string columns with the percent symbols to numeric percentages
to_percent <- function(orig_text) {
  without_symbol <- substr(orig_text,1, nchar(orig_text)-1)
  to_number <- as.numeric(without_symbol)
  to_percent <- to_number / 100
  return(to_percent)
}

new_pct <- sapply(df_NY_schools[, c("GRAD_PCT", "REG_PCT", "STILL_ENR_PCT", "GED_PCT",
                                    "DROPOUT_PCT", "LOCAL_PCT", "REG_ADV_PCT",
                                    "NON_DIPLOMA_CREDENTIAL_PCT")], to_percent)

df_NY_schools_withoutpct <- df_NY_schools %>% 
  select(-c("GRAD_PCT", "REG_PCT", "STILL_ENR_PCT", "GED_PCT",
            "DROPOUT_PCT", "LOCAL_PCT", "REG_ADV_PCT",
            "NON_DIPLOMA_CREDENTIAL_PCT"))

df_NY_schools_corrected <- cbind(df_NY_schools_withoutpct, new_pct)

# Now convert the counts to numeric
df_NY_schools_corrected[, c(20:28)] <- sapply(df_NY_schools_corrected[, c(20:28)],
                                              as.numeric)

# Check to see if the number of reported dropouts makes sense
df_NY_schools_corrected$dropout_check <- df_NY_schools_corrected$ENROLL_CNT - 
  df_NY_schools_corrected$GRAD_CNT -
  df_NY_schools_corrected$STILL_ENR_CNT

# Remove unnecessary columns and add year
df_NY_schools_corrected <- df_NY_schools_corrected %>% 
  select(-LEA_BEDS, -LEA_NAME, -NRC_DESC,
         -NYC_IND, -BOCES_CODE, -MEMBERSHIP_CODE, -MEMBERSHIP_KEY) %>% 
    mutate(Year = substr(MEMBERSHIP_DESC, 1, 4))

# Subset by statewide so have statewide reference for individual counties
# Remove one of the 4 year outcomes of the 2014 cohort (there is a june & august value)
# Choose August as it is more recent
df_state <- subset(df_NY_schools_corrected,
                   subset = AGGREGATION_TYPE == 'Statewide' &
                     MEMBERSHIP_DESC != '2014 Total Cohort - 4 Year Outcome')

# Subset data to a single aggregation index. In this case, we will choose county
df_county <- subset(x = df_NY_schools_corrected,
                    subset = AGGREGATION_TYPE == "County" &
                      MEMBERSHIP_DESC != '2014 Total Cohort - 4 Year Outcome')

# Create dataset of county-level appended to state-level
df_county_state <- rbind(df_county, df_state)

# Scatterplot dataset to see how graduation rates have changed over time, for 2012/13/14 cohorts
df_state_allcohort <- df_county_state %>% 
  filter(SUBGROUP_NAME == "All Students")

cohort_melted <- melt(df_state_allcohort, id.vars = c("COUNTY_NAME", "Year"))
cohort_subset <- cohort_melted %>%
  filter(variable %in% c("GRAD_PCT", "DROPOUT_PCT", "STILL_ENR_PCT"))
cohort_subset$value <- as.numeric(cohort_subset$value)


# First look at data for all students
all_stud <- df_county_state %>% 
  filter(SUBGROUP_NAME == "All Students") %>% 
  arrange(desc(DROPOUT_CNT))

all_stud_long <- melt(all_stud,
                      id.vars = c("AGGREGATION_TYPE", "AGGREGATION_NAME", 
                                  "COUNTY_NAME", "AGGREGATION_CODE", "Year"))

# Subset by variables of interest for bar chart
all_stud_long_bar <- all_stud_long %>% 
  filter(variable %in% c('GRAD_PCT', 'DROPOUT_PCT', 'STILL_ENR_PCT', 'GED_PCT'))

all_stud_long_bar$value = sapply(all_stud_long_bar$value, as.numeric)

# Create list of counties
county_names <- all_stud_long_bar %>% 
  filter(AGGREGATION_TYPE != "Statewide")

county_names$COUNTY_NAME <- as.character(county_names$COUNTY_NAME)


# # Create individual subgroup datasets
# df_gender <- df_county %>% 
#   filter(SUBGROUP_NAME %in% c('Male', 'Female'))
# 
# df_race <- df_county %>% 
#   filter(SUBGROUP_CODE %in% c(4,5,6,7,8,9))
# 
# # Test charts with Bronx county
# # Remove later
# bronx_test<- df_gender %>%  
#   filter(AGGREGATION_NAME %in% c("County: BRONX")) %>% 
#   arrange(desc(SUBGROUP_NAME)) %>% 
#   mutate(y_label_pos = cumsum(ENROLL_CNT) - .5*ENROLL_CNT)

```


Inputs {.sidebar}
=====================================
```{r}

# Select a county
# Need to alphabetize
selectInput(inputId = "county", "Select a county",
            choices = unique(county_names$COUNTY_NAME))

br()

# Select cohort year
radioButtons(inputId = "cohortYear", "Select a cohort year",
              choices = unique(df_county_state$Year), selected = '2014')


br()
# Select student demographic group
selectInput(inputId = "demoGroup", label = "Select student demographic  group", 
                   choices = c("Gender", "Ethnicity", "Economic Status", 
                               "Migrant Status"),
                   selected = "Gender")
    
```


General County-level Metrics
=====================================  

Column
-------------------------------------
    
### Student Enrollment

```{r}

# Value box for number of all students in the county per cohort
county_students <- reactive({
  df_county %>% 
    filter(COUNTY_NAME == input$county & Year == input$cohortYear) %>% 
    filter(SUBGROUP_NAME == "All Students")
})

renderValueBox({
  enrolled_students <- format(county_students()$ENROLL_CNT, big.mark = ",") 
  valueBox(caption = "Total Number of Cohort's Enrolled Students", value = 
             enrolled_students)
})

```
    
### County vs. State Metrics Comparison
```{r}

# Dataset for county and cohort year
selected_county <- reactive({
  all_stud_long_bar %>%  
    filter(Year == input$cohortYear) %>% 
    filter(AGGREGATION_NAME == "All Districts and Charters" | 
             COUNTY_NAME == input$county) 
  })

# Bar chart displaying graduation, dropout, still enrolled, and GED prep program rates by county as compared to NY state averages
# Need to flip x-axis ticks by 90 degrees
renderPlot({
  ggplot(selected_county()) +
    geom_bar(stat = "identity",
             aes(x = variable, y = value, fill = AGGREGATION_NAME),
             position = "dodge") +
  xlab("") +
  ylab('Rate') + 
  theme(legend.title = element_blank(),
        legend.text = element_text(size=14),
        axis.title = element_text(size=14),
        axis.text = element_text(size=14)) +
  scale_y_continuous(breaks=seq(0,1,.10))
  })

```

Gender-specific Metrics
=====================================  

### Gender-makeup

```{r}

# Filter by county
gender_county <- reactive({
  df_gender %>%  
    filter(AGGREGATION_NAME %in% input$county) %>% 
    arrange(desc(SUBGROUP_NAME)) %>% 
    mutate(y_label_pos = cumsum(ENROLL_CNT) - .5*ENROLL_CNT)
})

# Test: pie chart by gender for a given county
renderPlot({
  ggplot(gender_county(), aes(x = "", y = ENROLL_CNT, fill = SUBGROUP_NAME)) +
    geom_bar(stat = "identity", color = "white") +
    coord_polar("y", start = 0) +
    geom_text(aes(y = y_label_pos, label = ENROLL_CNT)) +
    theme_void() +
    theme(legend.title = element_blank()) +
    ggtitle("Gender Demographics")
})
```

### Graduation rate metrics by gender
```{r}
# Bar chart displaying requested metrics per county by gender
# **Need to change y-axis to a constant max value**
renderPlot({
  ggplot(data = gender_county()) +
  geom_bar(stat = "identity",
           aes(x = SUBGROUP_NAME, y = input$metrics))
})

  
```

Page 1: General County-level Stats
  inputs: county, year
  outputs: bar chart comparing rates to NY state avg
          value box: total enrolled
          gauge: graduation rate
Page 2: Stats by demographic
  inputs: county, year, demographic group
  outputs: bar chart comparing rates by group
          gauge: how        
Page 2: Trends over time by county
  inputs: county
  outputs: scatterplot by year


